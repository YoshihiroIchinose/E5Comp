# 機密情報や Exact Data Match の動作に関して
本ページで、Microsoft 365 環境における各種動作検証から、特に日本語環境でのカスタムの機密情報定義のマッチングや、Exact Data Match の仕組みについてまとめおきたい。

## カスタム機密情報のマッチングについて
正規表現やカスタムの機密情報のマッチングにおいては、テキスト抽出時点で元データに対しておおよそ以下のような下処理がなされている。
- 全角英数、全角記号や全角スペースなどは、対応する半角英数や半角スペースに変換される
- 半角カナは、全角カナに変換される
- Word でのテキストの抽出においては、全角数字が全角文字に隣接している場合は、半角数字に変換されるだけではなく、間にスペースが挿入される

|  元データ  | 注釈 |BOM あり UTF-8 の .txt 形式でのテキスト抽出 | .docx 形式の Word でのテキスト抽出 |
| ---- | ---- | ---- | ---- |
|  東京2020  | 半角数字はそのまま |  東京2020  | 東京2020 |
|  東京２０２０  | 全角数字は半角数字に変換 | 東京2020  | 東京 2020 |
| ABC分析 |  半角英字はそのまま | ABC分析 | ABC分析 |
| ＡＢＣ分析 |  全角英字は半角英字に変換 |ABC分析 | ABC分析 |
| ﾄｳｷｮｳﾄｼﾅｶﾞﾜｸﾉﾁｬﾝﾋﾟｵﾝ | 半角カナは全角カナに変換 | トウキョウトシナガワクノチャンピオン | トウキョウトシナガワクノチャンピオン |
| " " | 全角スペースは半角スペースに変換される | " " | " " |
| 「」”’‘ | これらの全角記号はそのまま | 「」”’‘ | 「」”’‘ |
| ！＃＄％＆（）－＾￥＠「；：」，．／＝～｜‘｛＋＊｝＜＞？＿ | これらの全角記号は半角に変換される | !#$%&()-^¥@「;:」,./=~\|‘{+*}<>?_ | !#$%&()-^¥@「;:」,./=~\|‘{+*}<>?_ |

これは以下のような Exchange Online 上の Test-TextExtraction を用いて確認することができる。
なお、Exchange Online では、BOM なし UTF-8 のテキストや、ANSI(Shift-JIS) 形式のテキストには対応しないため、これらの形式のテキストを指定した場合は解析できないというエラーとなる。(2022/05/23 時点) また SharePoint Online や Endpoint DLP ではエンジンが異なるため、多少動作も異なる可能性あり。
```
Connect-ExchangOnline
$content = Test-TextExtraction -FileData ([System.IO.File]::ReadAllBytes("E:\WorkData\Comp\テストデータ.docx"))
$content.ExtractedResults[0].ExtractedStreamText
```

## 正規表現やキーワードの指定の注意事項
上記のように、テキスト抽出時点で、全角英数・全角記号は、半角英数・半角記号に変換され、半角カナも全角カナに変換されるため、カスタムの機密情報での正規表現やキーワードを用いた定義においては、
全角の英数、全角の記号、半角カナなどの存在は意識する必要がなく、半角の英数、半角の記号、全角カナを用いた定義をしておくだけで、漏れなくマッチできるような動作となっている。
ただ、東京２０２０は、Word ファイルにおいて、東京 2020 と抽出されていたりするので、全角数字が半角数字に変換される際、半角スペースが入りうる可能性は考慮しておく必要がある。

## Exact Data Match の動作について
Exact Data Match では以下の 3 段階の定義に従って、検出および信頼度判定がなされる。
- A. Exact Data Match の主要素のマッチング候補となるテキストを抜き出す機密情報の種類の定義   
     正規表現を使ってカスタムの定義や、クレジットカード番号、マイナンバーなどの既存定義済みの機密情報も利用可能
- B. Exact Data Match としての検索可能な主要素のハッシュ
- C. Exact Data Match として補助要素なるハッシュ


### 上記の定義に従い、Exact Data Match の動作としては以下となっている。
1. 対象のデータから、全角英数・全角記号は、半角英数・半角記号に変換し、半角カナも全角カナに変換してテキストを抽出
2. A 機密情報の種類を使って対象となるパターンを見つける   
   この A のパターンの検出の際、A の定義でキーワードなどの補助要素を用いて、対象をフィルタリングすることも可能。   
   その場合でも、 Exact Data Match の主要素のマッチングに使われるテキストは、A の主要素のみが用いられる。
3. 見つかったパターンから Exact Data Match のスキーマ定義に従って、スペースやハイフンなど、無視する文字を削除してハッシュを生成
4. B で取り込んだ主要素のハッシュと 3 のハッシュを見比べて同じハッシュであれば、主要素のマッチング成功とする
5. C の補助要素のマッチングも必要な場合、主要素が見つかった前後の文字列を調査することになるが、   
前後の文字列をワードブレークし、ワードブレークされた単語ごとにハッシュを生成
6. C の補助要素のハッシュと 5 のハッシュを見比べてハッシュの一致があれば、補助要素のマッチング成功とする
7. Exact Data Match の機密情報の定義に従って、主要素と補助要素の検知結果に従った信頼度で検知結果を返す

### この動作における注意点・考慮事項は以下の通り。
- マッチング対処となるテキストでは、通常の機密情報の検出同様に、全角英数・全角記号などは半角に変換され、   
また半角カナなどは全角カナに変換されるため、Exact Data Match においても、半角英数・半角記号、全角カナだけを   
意識してデータを用意していればよい。
- A の前段階の機密情報の検出においては、EDM のスキーマで定義する無視する記号は考慮されていないため、   
  正規表現では、ハイフン、半角スペースがあるものやないもの 双方意識したパターンを用意しておく必要がある。
- 機密情報の検出は、DLP ポリシーの有無に関係なく、機密情報の種類を定義した段階で、Microsoft 365 全体で動作し、   
  機密情報の把握が行われるため、A の定義においては、広範なパターンのテキストを対象とするような内容は避けた方がよい。   
  対象が汎用的すぎると、処理がスキップされてしまう可能性あり。A の定義においても補助要素を追加するなどして、   
  対象を絞り込むことも有効。
- 半角カナは、全角カナに変換してマッチングが行われるが、半角カナでは、濁音・半濁音が 1 文字としてカウントされ、   
  全角カナへの変換の際、文字の位置が合わなくなることもあり、通常の機密情報の定義で、全角カナのキーワードで、   
  半角カナをマッチングすることは問題がないが、Eact Data Match で半角カナを対象とした場合、   
濁音・半濁音を含む半角カナが現状ヒットしない。(2022/05/23 時点)   
- Exact Data Match の補助要素のマッチング置いては、ハッシュを取り込む際には、ワードブレークを行わず、   
  1 カラム 1 ハッシュとして取り込むものの、補助要素の走査の際には、日本語の文書をワードブレークした上で、
  ハッシュ比較を行う。そのため、ワードブレークされうる漢字 3 文字などの補助要素は、Exact Data Match では見つからない。(2022/05/23 時点)   
  補助要素として見つかるものの例: 会社員、佐藤、隆、鈴木   
  補助要素として見つからないものの例: 伊集院、小鳥遊、会計士   
  (これらは、本文中からは伊集/院、小鳥/遊、会計/士 などのように複数の単語であるとワードブレークされ   
取り込んだハッシュと同じ分け方とはならず、同一のハッシュが見つからないため。   
Exact Data Match の検索可能な列・主要素の検知においては、    
A の前段階の機密情報の定義に従った正規用表現で対象となるテキストが抜き出されて、    
ハッシュが生成され比較されるので、ワードブレークには依存せずこのような問題は見られない。)    
